{"ast":null,"code":"import { Tween, Easing } from '@tweenjs/tween.js';\nimport { ThreeGltf } from '@amap/three-layer';\nclass CustomThreeGltf extends ThreeGltf {\n  constructor(layer, options, $vue, callback) {\n    options.onLoaded = gltf => {\n      gltf.isCustomGroup = true;\n      gltf.$vue = $vue;\n      this.moveAnimation = options.moveAnimation;\n      if (callback) {\n        callback();\n      }\n    };\n    super(layer, options);\n    this.moveFrame = -1;\n    this.angleFrame = -1;\n  }\n  setScale(scale) {\n    let scaleArray;\n    if (typeof scale === \"number\") {\n      scaleArray = [scale, scale, scale];\n    } else {\n      scaleArray = scale;\n    }\n    this.object.scale.set(...scaleArray);\n  }\n  setPosition(position) {\n    const positionConvert = this.layer.convertLngLat(position);\n    if (!this.moveAnimation || !this.moveAnimation.smooth) {\n      this._updatePosition(positionConvert);\n      this.prePosition = positionConvert;\n    } else {\n      if (!this.prePosition) {\n        this._updatePosition(positionConvert);\n        this.prePosition = positionConvert;\n      } else {\n        this._updatePositionTween(positionConvert);\n      }\n    }\n  }\n  _updatePositionTween(newPosition) {\n    var _a;\n    if (!this.prePosition) {\n      return;\n    }\n    if (this.prePositionTween) {\n      this.prePositionTween.end();\n    }\n    const preObj = {\n      x: this.prePosition[0],\n      y: this.prePosition[1]\n    };\n    this._stopMoveAnimation();\n    const duration = ((_a = this.moveAnimation) == null ? void 0 : _a.duration) || 1e3;\n    this.prePositionTween = new Tween(preObj).to({\n      x: newPosition[0],\n      y: newPosition[1]\n    }).duration(duration).easing(Easing.Linear.None).onUpdate(() => {\n      this._updatePosition([preObj.x, preObj.y]);\n    }).start();\n    this._moveAnimate();\n    this.prePosition = newPosition;\n  }\n  _moveAnimate() {\n    var _a;\n    (_a = this.prePositionTween) == null ? void 0 : _a.update();\n    this.moveFrame = requestAnimationFrame(() => {\n      this._moveAnimate();\n    });\n  }\n  _stopMoveAnimation() {\n    cancelAnimationFrame(this.moveFrame);\n  }\n  _updatePosition(position) {\n    this.object.position.setX(position[0]);\n    this.object.position.setY(position[1]);\n    this.refresh();\n  }\n  setAngle(angle) {\n    if (!this.moveAnimation || !this.moveAnimation.smooth) {\n      this._updateAngle(angle);\n      this.preAngle = angle;\n    } else {\n      if (this.preAngle === void 0) {\n        this._updateAngle(angle);\n        this.preAngle = angle;\n      } else {\n        this._updateAngleTween(angle);\n      }\n    }\n  }\n  _updateAngle(angle) {\n    const x = this.object.rotation.x;\n    const z = this.object.rotation.z;\n    const y = Math.PI / 180 * angle;\n    this.object.rotation.set(x, y, z);\n    this.refresh();\n  }\n  _updateAngleTween(angle) {\n    var _a;\n    if (this.preAngle === void 0) {\n      return;\n    }\n    if (this.preAngleTween) {\n      this.preAngleTween.end();\n    }\n    const preObj = {\n      angle: this.preAngle\n    };\n    this._stopAngleAnimation();\n    const duration = ((_a = this.moveAnimation) == null ? void 0 : _a.duration) || 1e3;\n    this.preAngleTween = new Tween(preObj).to({\n      angle\n    }).duration(duration).easing(Easing.Linear.None).onUpdate(() => {\n      this._updateAngle(preObj.angle);\n    }).onComplete(() => {\n      this._stopAngleAnimation();\n    }).start();\n    this._angleAnimate();\n    this.preAngle = angle;\n  }\n  _angleAnimate() {\n    var _a;\n    (_a = this.preAngleTween) == null ? void 0 : _a.update();\n    this.angleFrame = requestAnimationFrame(() => {\n      this._angleAnimate();\n    });\n  }\n  _stopAngleAnimation() {\n    cancelAnimationFrame(this.angleFrame);\n  }\n  setMoveAnimation(move) {\n    this.moveAnimation = move;\n  }\n  remove() {\n    if (this.object) {\n      this.layer.removeObject(this.object);\n    }\n  }\n  destroy() {\n    this._stopAngleAnimation();\n    this._stopMoveAnimation();\n    this.prePosition = void 0;\n    this.preAngle = void 0;\n    this.prePositionTween = void 0;\n    this.preAngleTween = void 0;\n    if (this.object) {\n      this.object.$vue = null;\n    }\n    super.destroy();\n  }\n}\nexport { CustomThreeGltf as default };","map":{"version":3,"mappings":"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","names":["ThreeGltf","constructor","options","callback","gltf","isCustomGroup","$vue","moveAnimation","layer","setScale","scale","scaleArray","setPosition","position","convertLngLat","smooth","_updatePosition","prePosition","_updatePositionTween","newPosition","prePositionTween","preObj","x","y","duration","Tween","to","Easing","Linear","onUpdate","_moveAnimate","requestAnimationFrame","_stopMoveAnimation","cancelAnimationFrame","setAngle","angle","_updateAngle","preAngle","_updateAngleTween","rotation","Math","object","set","preAngleTween","onComplete","_angleAnimate","_stopAngleAnimation","setMoveAnimation","move","remove","removeObject","destroy"],"sources":["../../../../../../src/packages/three/ThreeGltf/CustomThreeGltf.ts"],"sourcesContent":["import {Tween, Easing} from '@tweenjs/tween.js'\r\nimport {ThreeGltf} from '@amap/three-layer'\r\nimport type {GltfOptions} from '@amap/three-layer'\r\nimport type {MoveAnimation, Vec} from './Type'\r\n\r\ninterface Options extends GltfOptions{\r\n  moveAnimation?: MoveAnimation  // 位置移动是否开启动画，开启后将会以参数中的duration进行插帧移动\r\n}\r\n\r\nclass CustomThreeGltf extends ThreeGltf{\r\n  moveAnimation?: MoveAnimation;\r\n  prePosition?: number[]; // 前一次位置信息\r\n  prePositionTween?: Tween<any>;\r\n  moveFrame = -1; // 缓慢移动的动画帧\r\n  preAngle?: number; // 前一次角度信息\r\n  preAngleTween?: Tween<any>;\r\n  angleFrame = -1;\r\n\r\n  constructor(layer: any, options: Options, $vue: any, callback: () => void) {\r\n    options.onLoaded = (gltf) => {\r\n      (gltf as any).isCustomGroup = true;\r\n      (gltf as any).$vue = $vue;\r\n      this.moveAnimation = options.moveAnimation;\r\n      if(callback){\r\n        callback()\r\n      }\r\n    }\r\n    super(layer, options)\r\n  }\r\n\r\n  setScale(scale: number | number[] | Vec) {\r\n    let scaleArray: number[];\r\n    if (typeof scale === 'number') {\r\n      scaleArray = [scale, scale, scale];\r\n    } else {\r\n      scaleArray = scale as number[];\r\n    }\r\n    this.object.scale.set(...scaleArray);\r\n  }\r\n\r\n  setPosition(position) {\r\n    const positionConvert = this.layer.convertLngLat(position);\r\n    if (!this.moveAnimation || !this.moveAnimation.smooth) {\r\n      this._updatePosition(positionConvert);\r\n      this.prePosition = positionConvert;\r\n    } else {\r\n      if (!this.prePosition) {\r\n        this._updatePosition(positionConvert);\r\n        this.prePosition = positionConvert;\r\n      } else {\r\n        this._updatePositionTween(positionConvert);\r\n      }\r\n    }\r\n  }\r\n\r\n  _updatePositionTween(newPosition: number[]) {\r\n    if (!this.prePosition) {\r\n      return\r\n    }\r\n    if (this.prePositionTween) {\r\n      this.prePositionTween.end();\r\n    }\r\n    const preObj = {\r\n      x: this.prePosition[0],\r\n      y: this.prePosition[1]\r\n    };\r\n    this._stopMoveAnimation();\r\n    const duration = this.moveAnimation?.duration || 1000;\r\n    this.prePositionTween = new Tween<any>(preObj).to({\r\n      x: newPosition[0],\r\n      y: newPosition[1]\r\n    }).duration(duration).easing(Easing.Linear.None).onUpdate(() => {\r\n      this._updatePosition([preObj.x, preObj.y]);\r\n    }).start()\r\n    this._moveAnimate();\r\n    this.prePosition = newPosition;\r\n  }\r\n\r\n  _moveAnimate() {\r\n    this.prePositionTween?.update();\r\n    this.moveFrame = requestAnimationFrame(() => {\r\n      this._moveAnimate();\r\n    })\r\n  }\r\n\r\n  _stopMoveAnimation() {\r\n    cancelAnimationFrame(this.moveFrame);\r\n  }\r\n\r\n  _updatePosition(position) {\r\n    this.object.position.setX(position[0]);\r\n    this.object.position.setY(position[1]);\r\n    this.refresh();\r\n  }\r\n\r\n  setAngle(angle: number) {\r\n    if (!this.moveAnimation || !this.moveAnimation.smooth) {\r\n      this._updateAngle(angle);\r\n      this.preAngle = angle;\r\n    } else {\r\n      if (this.preAngle === undefined) {\r\n        this._updateAngle(angle);\r\n        this.preAngle = angle;\r\n      } else {\r\n        this._updateAngleTween(angle);\r\n      }\r\n    }\r\n  }\r\n\r\n  _updateAngle(angle){\r\n    const x = this.object.rotation.x;\r\n    const z = this.object.rotation.z;\r\n    const y = Math.PI / 180 * angle;\r\n    this.object.rotation.set(x, y, z);\r\n    this.refresh();\r\n  }\r\n\r\n  _updateAngleTween(angle){\r\n    if (this.preAngle === undefined) {\r\n      return\r\n    }\r\n    if (this.preAngleTween) {\r\n      this.preAngleTween.end();\r\n    }\r\n    const preObj = {\r\n      angle: this.preAngle\r\n    };\r\n    this._stopAngleAnimation();\r\n    const duration = this.moveAnimation?.duration || 1000;\r\n    this.preAngleTween = new Tween<any>(preObj).to({\r\n      angle\r\n    }).duration(duration).easing(Easing.Linear.None).onUpdate(() => {\r\n      this._updateAngle(preObj.angle);\r\n    }).onComplete(() => {\r\n      this._stopAngleAnimation();\r\n    }).start()\r\n    this._angleAnimate();\r\n    this.preAngle = angle;\r\n  }\r\n\r\n  _angleAnimate() {\r\n    this.preAngleTween?.update();\r\n    this.angleFrame = requestAnimationFrame(() => {\r\n      this._angleAnimate();\r\n    })\r\n  }\r\n\r\n  _stopAngleAnimation() {\r\n    cancelAnimationFrame(this.angleFrame);\r\n  }\r\n\r\n\r\n  setMoveAnimation(move){\r\n    this.moveAnimation = move;\r\n  }\r\n\r\n  remove(){\r\n    if (this.object) {\r\n      this.layer.removeObject(this.object)\r\n    }\r\n  }\r\n\r\n  destroy() {\r\n    this._stopAngleAnimation();\r\n    this._stopMoveAnimation();\r\n    this.prePosition = undefined;\r\n    this.preAngle = undefined;\r\n    this.prePositionTween = undefined;\r\n    this.preAngleTween = undefined;\r\n    if (this.object) {\r\n      this.object.$vue = null;\r\n    }\r\n    super.destroy();\r\n  }\r\n}\r\n\r\nexport default CustomThreeGltf\r\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}