{"ast":null,"code":"import { B3DMLoaderBase } from '../base/B3DMLoaderBase.js';\nimport { DefaultLoadingManager, Matrix4 } from 'three';\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\nexport class B3DMLoader extends B3DMLoaderBase {\n  constructor(manager = DefaultLoadingManager) {\n    super();\n    this.manager = manager;\n    this.adjustmentTransform = new Matrix4();\n  }\n  parse(buffer) {\n    const b3dm = super.parse(buffer);\n    const gltfBuffer = b3dm.glbBytes.slice().buffer;\n    return new Promise((resolve, reject) => {\n      const manager = this.manager;\n      const fetchOptions = this.fetchOptions;\n      const loader = manager.getHandler('path.gltf') || new GLTFLoader(manager);\n      if (fetchOptions.credentials === 'include' && fetchOptions.mode === 'cors') {\n        loader.setCrossOrigin('use-credentials');\n      }\n      if ('credentials' in fetchOptions) {\n        loader.setWithCredentials(fetchOptions.credentials === 'include');\n      }\n      if (fetchOptions.headers) {\n        loader.setRequestHeader(fetchOptions.headers);\n      }\n\n      // GLTFLoader assumes the working path ends in a slash\n      let workingPath = this.workingPath;\n      if (!/[\\\\/]$/.test(workingPath) && workingPath.length) {\n        workingPath += '/';\n      }\n      const adjustmentTransform = this.adjustmentTransform;\n      loader.parse(gltfBuffer, workingPath, model => {\n        const {\n          batchTable,\n          featureTable\n        } = b3dm;\n        const {\n          scene\n        } = model;\n        const rtcCenter = featureTable.getData('RTC_CENTER');\n        if (rtcCenter) {\n          scene.position.x += rtcCenter[0];\n          scene.position.y += rtcCenter[1];\n          scene.position.z += rtcCenter[2];\n        }\n        model.scene.updateMatrix();\n        model.scene.matrix.multiply(adjustmentTransform);\n        model.scene.matrix.decompose(model.scene.position, model.scene.quaternion, model.scene.scale);\n        model.batchTable = batchTable;\n        model.featureTable = featureTable;\n        scene.batchTable = batchTable;\n        scene.featureTable = featureTable;\n        resolve(model);\n      }, reject);\n    });\n  }\n}","map":{"version":3,"names":["B3DMLoaderBase","DefaultLoadingManager","Matrix4","GLTFLoader","B3DMLoader","constructor","manager","adjustmentTransform","parse","buffer","b3dm","gltfBuffer","glbBytes","slice","Promise","resolve","reject","fetchOptions","loader","getHandler","credentials","mode","setCrossOrigin","setWithCredentials","headers","setRequestHeader","workingPath","test","length","model","batchTable","featureTable","scene","rtcCenter","getData","position","x","y","z","updateMatrix","matrix","multiply","decompose","quaternion","scale"],"sources":["/Users/yanbinru/Desktop/代码/github/vue3-knowledge/node_modules/3d-tiles-renderer/src/three/B3DMLoader.js"],"sourcesContent":["import { B3DMLoaderBase } from '../base/B3DMLoaderBase.js';\nimport { DefaultLoadingManager, Matrix4 } from 'three';\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\n\nexport class B3DMLoader extends B3DMLoaderBase {\n\n\tconstructor( manager = DefaultLoadingManager ) {\n\n\t\tsuper();\n\t\tthis.manager = manager;\n\t\tthis.adjustmentTransform = new Matrix4();\n\n\t}\n\n\tparse( buffer ) {\n\n\t\tconst b3dm = super.parse( buffer );\n\t\tconst gltfBuffer = b3dm.glbBytes.slice().buffer;\n\t\treturn new Promise( ( resolve, reject ) => {\n\n\t\t\tconst manager = this.manager;\n\t\t\tconst fetchOptions = this.fetchOptions;\n\t\t\tconst loader = manager.getHandler( 'path.gltf' ) || new GLTFLoader( manager );\n\n\t\t\tif ( fetchOptions.credentials === 'include' && fetchOptions.mode === 'cors' ) {\n\n\t\t\t\tloader.setCrossOrigin( 'use-credentials' );\n\n\t\t\t}\n\n\t\t\tif ( 'credentials' in fetchOptions ) {\n\n\t\t\t\tloader.setWithCredentials( fetchOptions.credentials === 'include' );\n\n\t\t\t}\n\n\t\t\tif ( fetchOptions.headers ) {\n\n\t\t\t\tloader.setRequestHeader( fetchOptions.headers );\n\n\t\t\t}\n\n\t\t\t// GLTFLoader assumes the working path ends in a slash\n\t\t\tlet workingPath = this.workingPath;\n\t\t\tif ( ! /[\\\\/]$/.test( workingPath ) && workingPath.length ) {\n\n\t\t\t\tworkingPath += '/';\n\n\t\t\t}\n\n\t\t\tconst adjustmentTransform = this.adjustmentTransform;\n\n\t\t\tloader.parse( gltfBuffer, workingPath, model => {\n\n\t\t\t\tconst { batchTable, featureTable } = b3dm;\n\t\t\t\tconst { scene } = model;\n\n\t\t\t\tconst rtcCenter = featureTable.getData( 'RTC_CENTER' );\n\t\t\t\tif ( rtcCenter ) {\n\n\t\t\t\t\tscene.position.x += rtcCenter[ 0 ];\n\t\t\t\t\tscene.position.y += rtcCenter[ 1 ];\n\t\t\t\t\tscene.position.z += rtcCenter[ 2 ];\n\n\t\t\t\t}\n\n\t\t\t\tmodel.scene.updateMatrix();\n\t\t\t\tmodel.scene.matrix.multiply( adjustmentTransform );\n\t\t\t\tmodel.scene.matrix.decompose( model.scene.position, model.scene.quaternion, model.scene.scale );\n\n\t\t\t\tmodel.batchTable = batchTable;\n\t\t\t\tmodel.featureTable = featureTable;\n\n\t\t\t\tscene.batchTable = batchTable;\n\t\t\t\tscene.featureTable = featureTable;\n\n\t\t\t\tresolve( model );\n\n\t\t\t}, reject );\n\n\t\t} );\n\n\t}\n\n}\n"],"mappings":"AAAA,SAASA,cAAc,QAAQ,2BAA2B;AAC1D,SAASC,qBAAqB,EAAEC,OAAO,QAAQ,OAAO;AACtD,SAASC,UAAU,QAAQ,0CAA0C;AAErE,OAAO,MAAMC,UAAU,SAASJ,cAAc,CAAC;EAE9CK,WAAW,CAAEC,OAAO,GAAGL,qBAAqB,EAAG;IAE9C,KAAK,EAAE;IACP,IAAI,CAACK,OAAO,GAAGA,OAAO;IACtB,IAAI,CAACC,mBAAmB,GAAG,IAAIL,OAAO,EAAE;EAEzC;EAEAM,KAAK,CAAEC,MAAM,EAAG;IAEf,MAAMC,IAAI,GAAG,KAAK,CAACF,KAAK,CAAEC,MAAM,CAAE;IAClC,MAAME,UAAU,GAAGD,IAAI,CAACE,QAAQ,CAACC,KAAK,EAAE,CAACJ,MAAM;IAC/C,OAAO,IAAIK,OAAO,CAAE,CAAEC,OAAO,EAAEC,MAAM,KAAM;MAE1C,MAAMV,OAAO,GAAG,IAAI,CAACA,OAAO;MAC5B,MAAMW,YAAY,GAAG,IAAI,CAACA,YAAY;MACtC,MAAMC,MAAM,GAAGZ,OAAO,CAACa,UAAU,CAAE,WAAW,CAAE,IAAI,IAAIhB,UAAU,CAAEG,OAAO,CAAE;MAE7E,IAAKW,YAAY,CAACG,WAAW,KAAK,SAAS,IAAIH,YAAY,CAACI,IAAI,KAAK,MAAM,EAAG;QAE7EH,MAAM,CAACI,cAAc,CAAE,iBAAiB,CAAE;MAE3C;MAEA,IAAK,aAAa,IAAIL,YAAY,EAAG;QAEpCC,MAAM,CAACK,kBAAkB,CAAEN,YAAY,CAACG,WAAW,KAAK,SAAS,CAAE;MAEpE;MAEA,IAAKH,YAAY,CAACO,OAAO,EAAG;QAE3BN,MAAM,CAACO,gBAAgB,CAAER,YAAY,CAACO,OAAO,CAAE;MAEhD;;MAEA;MACA,IAAIE,WAAW,GAAG,IAAI,CAACA,WAAW;MAClC,IAAK,CAAE,QAAQ,CAACC,IAAI,CAAED,WAAW,CAAE,IAAIA,WAAW,CAACE,MAAM,EAAG;QAE3DF,WAAW,IAAI,GAAG;MAEnB;MAEA,MAAMnB,mBAAmB,GAAG,IAAI,CAACA,mBAAmB;MAEpDW,MAAM,CAACV,KAAK,CAAEG,UAAU,EAAEe,WAAW,EAAEG,KAAK,IAAI;QAE/C,MAAM;UAAEC,UAAU;UAAEC;QAAa,CAAC,GAAGrB,IAAI;QACzC,MAAM;UAAEsB;QAAM,CAAC,GAAGH,KAAK;QAEvB,MAAMI,SAAS,GAAGF,YAAY,CAACG,OAAO,CAAE,YAAY,CAAE;QACtD,IAAKD,SAAS,EAAG;UAEhBD,KAAK,CAACG,QAAQ,CAACC,CAAC,IAAIH,SAAS,CAAE,CAAC,CAAE;UAClCD,KAAK,CAACG,QAAQ,CAACE,CAAC,IAAIJ,SAAS,CAAE,CAAC,CAAE;UAClCD,KAAK,CAACG,QAAQ,CAACG,CAAC,IAAIL,SAAS,CAAE,CAAC,CAAE;QAEnC;QAEAJ,KAAK,CAACG,KAAK,CAACO,YAAY,EAAE;QAC1BV,KAAK,CAACG,KAAK,CAACQ,MAAM,CAACC,QAAQ,CAAElC,mBAAmB,CAAE;QAClDsB,KAAK,CAACG,KAAK,CAACQ,MAAM,CAACE,SAAS,CAAEb,KAAK,CAACG,KAAK,CAACG,QAAQ,EAAEN,KAAK,CAACG,KAAK,CAACW,UAAU,EAAEd,KAAK,CAACG,KAAK,CAACY,KAAK,CAAE;QAE/Ff,KAAK,CAACC,UAAU,GAAGA,UAAU;QAC7BD,KAAK,CAACE,YAAY,GAAGA,YAAY;QAEjCC,KAAK,CAACF,UAAU,GAAGA,UAAU;QAC7BE,KAAK,CAACD,YAAY,GAAGA,YAAY;QAEjChB,OAAO,CAAEc,KAAK,CAAE;MAEjB,CAAC,EAAEb,MAAM,CAAE;IAEZ,CAAC,CAAE;EAEJ;AAED"},"metadata":{},"sourceType":"module","externalDependencies":[]}